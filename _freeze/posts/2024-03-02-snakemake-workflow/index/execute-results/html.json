{
  "hash": "d53b57366640b4aacc49ee042722047f",
  "result": {
    "markdown": "---\ntitle: 使用Github的Snakemake流程\nauthor: metseq\ndate: '2024-03-02'\ncategories:\n  - Bioinformatics\ntoc: true\nnumber-sections: false\nexecute:\n  eval: false\n  echo: true\n  warning: false\n  message: false\n---\n\n# 概述\nGitHub有一个[snakemake流程的分类](https://snakemake.github.io/snakemake-workflow-catalog/)，里面有很多生信分析流程，rna-seq-star-deseq2，dna-seq-gatk-variant-calling。\n\n我测试了[rna-seq-star-deseq2](https://github.com/snakemake-workflows/rna-seq-star-deseq2)这个流程。\n\n每个流程都有使用说明，如果都看说明可以跑通，那就好了🥹\n\n下面参考[rna-seq-star-deseq2的说明](https://snakemake.github.io/snakemake-workflow-catalog/?usage=snakemake-workflows%2Frna-seq-star-deseq2)，一步一步做.\n\n\n# Step 1 安装snamake和snakedeploy\n\n\n```{bash}\n# 使用mamba安装snakeme和snakedeploy，如果没有mamba，自行搜索安装吧\nmamba create -c conda-forge -c bioconda --name snakemake snakemake snakedeploy\n\nconda activate snakemake\n```\n\n\n# Step 2 流程部署\n\n\n```{bash}\nmkdir proj_240302_test_snakemake\n\ncd proj_240302_test_snakemake\n\nsnakedeploy deploy-workflow https://github.com/snakemake-workflows/rna-seq-star-deseq2 . --tag v2.1.0\n```\n\n\n运行时候的文件结构：\n\n\n```{bash}\n$ tree\n.\n├── config\n│   ├── README.md\n│   ├── config.yaml\n│   ├── samples.tsv\n│   └── units.tsv\n└── workflow\n    └── Snakefile\n```\n\n\n其实就下了config和workflow两个文件夹，里面分别是配置文件和流程。workflow里面只有一个Snakefile，Snakefile里把github上\nrna-seq-star-deseq2的流程作为模块导入了。\n\n# Step 3 配置流程\n\n流程配置是最麻烦的，我下载了[仓库](https://github.com/snakemake-workflows/rna-seq-star-deseq2.git)自带的测试数据。\n\n测试数据在`.test`文件夹下面，结构如下，应该很清楚了，`config_basic`就是简单版的配置文件，`config_complex`文件夹是复杂版的配置文件，`ngs-test-data`就是原始数据了。\n\n\n```{bash}\n$ tree .test\n.\n├── config_basic\n│   ├── config.yaml\n│   ├── samples.tsv\n│   └── units.tsv\n├── config_complex\n│   ├── config.yaml\n│   ├── samples.tsv\n│   └── units.tsv\n└── ngs-test-data\n    └── reads\n        ├── a.chr21.1.fq\n        ├── a.chr21.2.fq\n        ├── a.scerevisiae.1.fq\n        ├── a.scerevisiae.2.fq\n        ├── b.chr21.1.fq\n        ├── b.chr21.2.fq\n        ├── b.scerevisiae.1.fq\n        ├── b.scerevisiae.2.fq\n        ├── c.scerevisiae.1.fq\n        └── c.scerevisiae.2.fq\n\n5 directories, 16 files\n```\n\n\n删掉`Step 2 流程部署`下载的config文件，把`.test/config_basic`中的配置文件都拷贝`proj_240302_test_snakemake/config`文件夹下，然后把`.test/ngs-test-data`文件夹拷贝到`proj_240302_test_snakemake`文件夹。\n\n修改`proj_240302_test_snakemake/config/config.yaml`文件的samples和unit配置路径：\n\n\n```{bash}\nsamples: config/samples.tsv\nunits: config/units.tsv\n```\n\n\n配置有很多细节，比如原始数据的接头序列，差异表达分组信息，是否是链特异文库等等。\n\n请参考配置文件的说明和流程自带的配置说明。当然`.test`文件夹中的配置文件格式值得参考。\n\n# Step 4 运行流程\n\n终于可以运行流程了：\n\n\n```{bash}\nsnakemake --cores all --use-conda\n```\n\n\n果然报错了😭：\n\n```\nNotImplementedError: Remote providers have been replaced by Snakemake storage plugins. Please use the corresponding storage plugin instead (snakemake-storage-plugin-*).\n```\n\nGoogle一下，rna-seq-star-deseq2里有一个[issues](https://github.com/snakemake-workflows/rna-seq-star-deseq2/issues/71)就是这个问题。\n\n原因是snakemake流程最近（2024年3月3日）日更新到版本8了，版本8引入了plugin功能，rna-seq-star-deseq2流程还不支持。issues里也给出了解决办法，删除已经装好的snakemake的conda环境，然后安装7.32.4版本的snakemake。\n\n\n```{bash}\nmamba deactivate\n\nmamba remove -n snakemake --all\n\nmamba create -c conda-forge -c bioconda -n snakemake7 snakemake=7.32.4 \n\nmamba activate snakemake7\n```\n\n\n重新配置好环境后，再次运行流程：\n\n\n```{bash}\nsnakemake --cores all --use-conda\n```\n\n\n流程会先下载依赖的环境，参考基因组（我用了大约20分钟），然后运行里面定义的步骤。\n\n结果文件在`results`文件夹下：\n\n\n```{bash}\n$ ll -rth results/\ntotal 120\ndrwxr-xr-x  14 chenmin  staff   448B Mar  3 00:17 trimmed\ndrwxr-xr-x   6 chenmin  staff   192B Mar  3 00:20 star\ndrwxr-xr-x   4 chenmin  staff   128B Mar  3 00:21 qc\ndrwxr-xr-x   4 chenmin  staff   128B Mar  3 00:22 counts\n-rw-r--r--@  1 chenmin  staff    59K Mar  3 00:22 pca.condition.svg\ndrwxr-xr-x   5 chenmin  staff   160B Mar  3 00:22 deseq2\ndrwxr-xr-x   5 chenmin  staff   160B Mar  3 00:23 diffexp\n```\n\n\n# Step 5 生成报告\n\n\n```{bash}\nsnakemake --report report.zip\n```\n\n\n解压report.zip，打开report.html，网页左侧有4个选项，Workflow是流程运行的步骤，说明；Statistics统计了每一步运行的时间；About是流程用到软件的使用权限说明；Results是最关心的结果了。\n\n测试完成🎉\n\n",
    "supporting": [
      "index_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}